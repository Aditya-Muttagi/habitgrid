<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HabitGrid — My Habits</title>
  <link rel="icon" type="image/png" href="/favicon.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .btn { transition: background-color 0.35s ease, border-color 0.35s ease, color 0.25s ease, box-shadow 0.2s ease; }
    .hidden { display:none; }
    .card { min-height:120px; }
    #createFormWrap { max-width:420px; margin-left:auto; margin-right:0; }
    button[disabled]{ opacity:0.6; pointer-events:none; }
    .btn:active { transform: translateY(1px); }
  </style>
</head>
<body class="bg-light">

<nav class="navbar navbar-light bg-white border-bottom">
  <div class="container d-flex justify-content-between">
    <a class="navbar-brand fw-bold" href="index.html">HabitGrid</a>
    <div>
      <button id="logoutBtn" class="btn btn-outline-danger btn-sm">Logout</button>
    </div>
  </div>
</nav>

<main class="container py-4">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">My Habits</h2>
    <div>
      <button id="refreshBtn" class="btn btn-sm btn-outline-secondary me-2">Refresh</button>
      <button id="toggleCreateBtn" class="btn btn-primary btn-sm">Add Habit</button>
    </div>
  </div>

  <div id="alert" class="alert p-2 hidden" role="alert"></div>

  <div class="row g-3" id="habitsList"></div>

  <div id="createFormWrap" class="mt-4 hidden">
    <div class="card shadow-sm p-3">
      <form id="createForm" class="d-flex gap-2 align-items-center">
        <input id="habitName" class="form-control" placeholder="Habit name" required />
        <button id="createSubmit" class="btn btn-primary" type="submit">Create</button>
        <button id="cancelCreateBtn" type="button" class="btn btn-outline-secondary">Cancel</button>
      </form>
    </div>
  </div>

</main>

<script src="app.js"></script>
<script>
(function () {

  requireAuth();

  const alertEl = document.getElementById('alert');
  const habitsList = document.getElementById('habitsList');
  const logoutBtn = document.getElementById('logoutBtn');
  const refreshBtn = document.getElementById('refreshBtn');
  const toggleCreateBtn = document.getElementById('toggleCreateBtn');

  const createFormWrap = document.getElementById('createFormWrap');
  const createForm = document.getElementById('createForm');
  const habitName = document.getElementById('habitName');
  const createSubmit = document.getElementById('createSubmit');
  const cancelCreateBtn = document.getElementById('cancelCreateBtn');

  function showAlert(msg, type='danger') {
    alertEl.textContent = msg;
    alertEl.className = 'alert alert-' + type + ' p-2';
    alertEl.classList.remove('hidden');
    if (type === 'success') setTimeout(()=> alertEl.classList.add('hidden'), 2200);
  }
  function hideAlert(){ alertEl.classList.add('hidden'); }

  function showCreate() { createFormWrap.classList.remove('hidden'); habitName.focus(); }
  function hideCreate() { createFormWrap.classList.add('hidden'); createForm.reset(); }

  logoutBtn.addEventListener('click', () => {
    clearToken();
    window.location.href = 'login.html';
  });

  toggleCreateBtn.addEventListener('click', () => {
    createFormWrap.classList.contains('hidden') ? showCreate() : hideCreate();
  });
  cancelCreateBtn.addEventListener('click', hideCreate);
  refreshBtn.addEventListener('click', loadHabits);

  /* CREATE HABIT */
  createForm.addEventListener('submit', async (ev) => {
    ev.preventDefault();
    createSubmit.disabled = true;
    hideAlert();
    try {
      const name = habitName.value.trim();
      if (!name) throw new Error('Name is required');
      await apiRequest('/habits/', 'POST', { name }, getToken());
      showAlert('Habit created', 'success');
      hideCreate();
      await loadHabits();
    } catch (err) {
      showAlert(err?.message || JSON.stringify(err));
    } finally {
      createSubmit.disabled = false;
    }
  });

  /* LOAD HABITS */
  async function loadHabits() {
    hideAlert();
    habitsList.innerHTML = '<div class="col-12 text-center text-muted py-4">Loading…</div>';
    try {
      const data = await apiRequest('/habits/today', 'GET', null, getToken());
      renderHabits(data || []);
    } catch (err) {
      if (err?.detail === 'Could not validate credentials' || err?.message === 'Unauthorized') {
        clearToken();
        window.location.href = 'login.html';
        return;
      }
      showAlert(err?.message || JSON.stringify(err));
      habitsList.innerHTML = '';
    }
  }

  /* RENDER HABITS */
  function renderHabits(items) {
    if (!Array.isArray(items) || items.length === 0) {
      habitsList.innerHTML = '<div class="col-12 text-center text-muted py-4">No habits yet. Add one above.</div>';
      return;
    }

    habitsList.innerHTML = '';

    items.forEach((h, index) => {
      const habitId = h.habit_id ?? h.id ?? null;
      const doneVal = h.done ?? false;

      const col = document.createElement('div');
      col.className = 'col-md-6 col-lg-4';

      const card = document.createElement('div');
      card.className = 'card h-100 shadow-sm p-3 d-flex flex-column';
      card.dataset.habitId = habitId;

      const title = document.createElement('h5');
      title.className = 'mb-3';
      title.textContent = h.name ?? 'Unnamed habit';

      const footer = document.createElement('div');
      footer.className = 'mt-auto d-flex justify-content-between align-items-center';

      /* TOGGLE DONE BUTTON */
      const toggleBtn = document.createElement('button');
      toggleBtn.className = doneVal ? 'btn btn-sm btn-success' : 'btn btn-sm btn-outline-success';
      toggleBtn.textContent = doneVal ? 'Done ✓' : 'Mark done';

      toggleBtn.onclick = async () => {
        const newDone = !doneVal;
        toggleBtn.disabled = true;
        try {
          await apiRequest(`/habits/${habitId}/today`, 'POST', { done: newDone }, getToken());
          await loadHabits();
        } catch (err) {
          showAlert(err?.message || JSON.stringify(err));
        } finally {
          toggleBtn.disabled = false;
        }
      };

      /* DELETE BUTTON — one click, no confirmation */
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'btn btn-sm btn-outline-danger';
      deleteBtn.textContent = 'Delete';

      deleteBtn.onclick = async () => {
        deleteBtn.disabled = true;
        try {
          await apiRequest(`/habits/${habitId}`, 'DELETE', null, getToken());
          await loadHabits();
        } catch (err) {
          showAlert(err?.message || JSON.stringify(err));
          deleteBtn.disabled = false;
        }
      };

      footer.appendChild(toggleBtn);
      footer.appendChild(deleteBtn);

      card.appendChild(title);
      card.appendChild(footer);
      col.appendChild(card);
      habitsList.appendChild(col);
    });
  }

  loadHabits();

})();
</script>
</body>
</html>

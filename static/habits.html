<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HabitGrid — My Habits</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
  <div class="container">
    <a class="navbar-brand fw-bold" href="index.html">HabitGrid</a>
    <div>
      <button id="logoutBtn" class="btn btn-outline-danger">Logout</button>
    </div>
  </div>
</nav>

<main class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">My Habits</h2>
    <div>
      <button class="btn btn-sm btn-outline-secondary me-2" id="refreshBtn">Refresh</button>
      <button class="btn btn-primary" id="openCreateBtn">Add Habit</button>
    </div>
  </div>

  <div id="alert" class="alert d-none" role="alert"></div>

  <div id="habitsList" class="row g-3"></div>

  <!-- Create modal (Bootstrap simple modal) -->
  <div class="modal" tabindex="-1" id="createModal">
    <div class="modal-dialog modal-md">
      <div class="modal-content">
        <form id="createForm">
          <div class="modal-header">
            <h5 class="modal-title">Create Habit</h5>
            <button type="button" class="btn-close" id="closeCreateBtn" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label class="form-label">Title</label>
              <input id="habitTitle" required class="form-control" />
            </div>
            <div class="mb-3">
              <label class="form-label">Description (optional)</label>
              <textarea id="habitDesc" rows="3" class="form-control"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button id="createSubmit" class="btn btn-primary" type="submit">Create</button>
            <button type="button" class="btn btn-outline-secondary" id="cancelCreateBtn">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</main>

<script src="app.js"></script>
<script>
  (function () {
    requireAuth(); // redirects to login if no token

    const alertEl = document.getElementById('alert');
    const habitsList = document.getElementById('habitsList');
    const logoutBtn = document.getElementById('logoutBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const openCreateBtn = document.getElementById('openCreateBtn');

    // modal elements
    const createModal = document.getElementById('createModal');
    const createForm = document.getElementById('createForm');
    const habitTitle = document.getElementById('habitTitle');
    const habitDesc = document.getElementById('habitDesc');
    const createSubmit = document.getElementById('createSubmit');
    const closeCreateBtn = document.getElementById('closeCreateBtn');
    const cancelCreateBtn = document.getElementById('cancelCreateBtn');

    // basic modal helper (no Bootstrap JS required)
    function showModal() {
      createModal.style.display = 'block';
      createModal.classList.add('show');
    }
    function hideModal() {
      createModal.style.display = 'none';
      createModal.classList.remove('show');
      createForm.reset();
    }

    openCreateBtn.addEventListener('click', showModal);
    closeCreateBtn.addEventListener('click', hideModal);
    cancelCreateBtn.addEventListener('click', hideModal);

    logoutBtn.addEventListener('click', () => {
      clearToken();
      window.location.href = 'login.html';
    });

    refreshBtn.addEventListener('click', loadHabits);

    createForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        createSubmit.disabled = true;
        try {
            const title = habitTitle.value.trim();
            const description = habitDesc.value.trim();
            if (!title) throw new Error('Title required');

            // POST to the backend-created route (trailing slash required by backend)
            await apiRequest('/habits/', 'POST', { title, description }, getToken());

            showSuccess('Habit created');
            hideModal();
            await loadHabits();
        } catch (err) {
            showError(err?.message || JSON.stringify(err));
        } finally {
            createSubmit.disabled = false;
        }
    });


    async function loadHabits() {
        alertEl.classList.add('d-none');
        habitsList.innerHTML = '<div class="col-12 text-center text-muted py-4">Loading…</div>';
        try {
            // GET today's habits (backend exposes /habits/today)
            const data = await apiRequest('/habits/today', 'GET', null, getToken());
            renderHabits(data || []);
        } catch (err) {
            if ((err && err.detail === 'Could not validate credentials') || err?.message === 'Unauthorized') {
             clearToken();
             window.location.href = 'login.html';
             return;
            }
            showError(err?.message || JSON.stringify(err));
            habitsList.innerHTML = '';
        }
    }


    function renderHabits(items) {
      if (!Array.isArray(items) || items.length === 0) {
        habitsList.innerHTML = '<div class="col-12 text-center text-muted py-4">No habits yet. Add one above.</div>';
        return;
      }
      habitsList.innerHTML = '';
      items.forEach(h => {
        // each habit card
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4';
        const card = document.createElement('div');
        card.className = 'card h-100 shadow-sm';
        const body = document.createElement('div');
        body.className = 'card-body d-flex flex-column';
        const title = document.createElement('h5');
        title.textContent = h.title;
        title.className = 'card-title';
        const desc = document.createElement('p');
        desc.className = 'card-text text-muted';
        desc.textContent = h.description || '';
        const footer = document.createElement('div');
        footer.className = 'mt-auto d-flex justify-content-between align-items-center';

        // toggle button (mark done) — backend expects POST /habits/{id}/today
        const toggleBtn = document.createElement('button');
        toggleBtn.className = 'btn btn-sm btn-outline-success';
        toggleBtn.textContent = h.done_today ? 'Done today ✓' : 'Mark done';
        toggleBtn.onclick = async () => {
          try {
            await apiRequest(`/habits/${h.id}/today`, 'POST', null, getToken());
            await loadHabits();
          } catch (err) {
            showError(err?.message || JSON.stringify(err));
          }
        };

        footer.appendChild(toggleBtn);

        body.appendChild(title);
        body.appendChild(desc);
        body.appendChild(footer);
        card.appendChild(body);
        col.appendChild(card);
        habitsList.appendChild(col);
      });
    }

    function showError(msg) {
      alertEl.textContent = msg;
      alertEl.className = 'alert alert-danger';
      alertEl.classList.remove('d-none');
    }
    function showSuccess(msg) {
      alertEl.textContent = msg;
      alertEl.className = 'alert alert-success';
      alertEl.classList.remove('d-none');
      setTimeout(() => alertEl.classList.add('d-none'), 2500);
    }

    loadHabits();
  })();
</script>
</body>
</html>
